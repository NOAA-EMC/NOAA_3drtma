<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE workflow [

<!ENTITY ACCOUNT "rtrr">
<!ENTITY ACCOUNT_DA "rtrr">
<!ENTITY ACCOUNT_PYTHON "rtrr">
<!ENTITY SCHEDULER "slurm">

<!ENTITY PARTITION "kjet">
<!ENTITY PARTITION_DA "kjet">
<!ENTITY PARTITION_PYTHON "xjet:vjet:kjet:sjet:ujet">
<!ENTITY QUEUE "batch">
<!ENTITY RES_DA "rtma-kjet">
<!ENTITY RES_POST "rtma-kjet">

<!ENTITY SYSTEM_ID "RTMA3D_dev1">
<!ENTITY HOMEBASE_DIR "/home/rtrr/RTMA_3D_dev1">
<!ENTITY DATABASE_DIR "/home/rtrr/rtma_3d_dev1_databasedir">
<!ENTITY JOBNAME_PRE "RTMA3D_dev1">
<!ENTITY envir "esrl"> 
<!ENTITY KEEPDATA "YES">
<!ENTITY DOMAIN "conus">
<!ENTITY FG_FALLBACK "NO">

<!ENTITY NCL_VER "6.5.0">
<!ENTITY SCRIPTS "&HOMEBASE_DIR;/scripts">
<!ENTITY PYTHON_SCRIPTS "&HOMEBASE_DIR;/scripts/python/adb_graphics">
<!ENTITY STATIC_DIR "&HOMEBASE_DIR;/fix">

<!ENTITY WPS_ROOT "&HOMEBASE_DIR;/exec/WPS">
<!ENTITY WRF_ROOT "&HOMEBASE_DIR;/exec/WRF">
<!ENTITY UNIPOST_EXEC "&HOMEBASE_DIR;/exec/UPP">
<!ENTITY SMARTINIT_EXEC "&HOMEBASE_DIR;/exec/smartinit"> 
<!ENTITY WGRIB1 "&HOMEBASE_DIR;/exec/UPP/wgrib">
<!ENTITY WGRIB "&HOMEBASE_DIR;/exec/UPP/wgrib2">
<!ENTITY GSI_ROOT "&HOMEBASE_DIR;/exec/GSI">
<!ENTITY FIX_ROOT "&STATIC_DIR;/GSI">

<!ENTITY MODULE_DIR "/home/rtrr/FIX_EXEC_MODULE/modulefiles">
<!ENTITY MODULE_FILE "&MODULE_DIR;/modulefile.jet.RAPHRRR">
<!ENTITY MODULE_NCO  "&MODULE_DIR;/modulefile.jet.NCOworkflow">

<!ENTITY SCRIPT_DIR "&HOMEBASE_DIR;/scripts">
<!ENTITY JJOB_DIR   "&HOMEBASE_DIR;/jobs">
<!ENTITY WRKFLW_DIR "&HOMEBASE_DIR;/xml">

<!ENTITY MACHINE    "jet">
<!ENTITY OBS_DIR "/public/data">
<!ENTITY HRRR_DIR "/home/rtrr/hrrr">
<!ENTITY HRRRfcst_DIR "/home/rtrr/hrrrv4_ncepfcst">
<!ENTITY SST_DIR "&OBS_DIR;/grids/ncep/sst/0p083deg/grib2">

<!ENTITY GFS_DIR "&OBS_DIR;/grids/gfs/0p5deg/grib2">
<!ENTITY ENKFFCST_DIR "&OBS_DIR;/grids/enkf/atm_v15">
<!ENTITY HRRRDAS_DIR "/home/rtrr/hrrrdas">

<!ENTITY AIRCRAFT_REJECT "/home/amb-verif/acars_RR/amdar_reject_lists">
<!ENTITY SFCOBS_USELIST "/home/amb-verif/ruc_madis_surface/mesonet_uselists">
<!ENTITY PREPBUFR_DIR "&OBS_DIR;/grids/rap/obs">
<!ENTITY PREPBUFR_EARLY_DIR "&OBS_DIR;/grids/rap/prepbufr_test">
<!ENTITY PREPBUFR_SAT_DIR "&OBS_DIR;/grids/rap/radiance">
<!ENTITY LIGHTNING_DIR "&OBS_DIR;/lightning">
<!ENTITY BUFRLIGHTNING_DIR "/lfs4/BMC/rtwbl/mhu/rapobs/rapobs_para">
<!ENTITY RADAR_DIR "&OBS_DIR;/radar/mrms">
<!ENTITY SATELLITE_DIR "&OBS_DIR;/sat/nasa">
<!ENTITY LANGLEY_BUFR_DIR "&OBS_DIR;/grids/rap/obs">
<!ENTITY RADVELLEV2_DIR "&OBS_DIR;/grids/rap/nexrad">
<!ENTITY RADVELLEV2P5_DIR "&OBS_DIR;/grids/rap/radwnd">
<!ENTITY SATWND_DIR "&OBS_DIR;/grids/rap/satwnd">
<!ENTITY NACELLE_RSD "&OBS_DIR;/tower/restricted/nacelle/netcdf">
<!ENTITY TOWER_RSD "&OBS_DIR;/tower/restricted/met/netcdf">
<!ENTITY TOWER_NRSD "&OBS_DIR;/tower/public/netcdf">
<!ENTITY SODAR_NRSD "&OBS_DIR;/profiler/wind/external/netcdf">
<!ENTITY TAMDAR_DIR "&OBS_DIR;/acars/raw/netcdf">
<!ENTITY NCEPSNOW_DIR "&OBS_DIR;/grids/ncep/snow/ims96/grib2">
<!ENTITY HIGHRES_SST_DIR "&OBS_DIR;/grids/ncep/sst/0p083deg/grib2">
<!ENTITY HIGHRES_SST14KM_DIR "&OBS_DIR;/grids/ncep/sst/grib">
<!ENTITY TCVITALS_DIR "&OBS_DIR;/nhc/tcvitals">
<!ENTITY STICKNET_DIR "&OBS_DIR;/vortex-se/stesonet">

<!ENTITY LOG_DIR "&DATABASE_DIR;/log">
<!ENTITY DATAROOT_ENS "&DATABASE_DIR;/gfsenkf">
<!ENTITY DATAROOT "&DATABASE_DIR;/run">

<!ENTITY POST_NAME "hrconus">
<!ENTITY FCST_LENGTH "20"> <!--20 secconds -->

<!ENTITY SMARTINIT_PROC "1">
<!ENTITY CONVENTIONAL_PROC "1">
<!ENTITY LIGHTNING_PROC "1">
<!ENTITY RADAR_PROC "33">
<!ENTITY SATELLITE_PROC "1">
<!-- ENTITY GSI_HYB_PROC "9:ppn=20"-->
<!-- ENTITY GSIRUN_CORES "180"-->
<!ENTITY GSI_HYB_PROC "7:ppn=40">
<!ENTITY GSIRUN_CORES "280">
<!ENTITY WRF_PROC "280">
<!ENTITY DIAG_STATS_PROC "1">

<!ENTITY POST_PROC "32">
<!ENTITY NCL_PROC "1">
<!ENTITY NCL_MAIN_PROC "8">
<!ENTITY CLEAN_PROC "1">
<!ENTITY PYTHON_MAPS_NODES "1:ppn=12">
<!ENTITY PYTHON_SKEWT_NODES "1:ppn=12">

<!ENTITY SMARTINIT_RESOURCES "<walltime>00:10:00</walltime><memory>10G</memory>">
<!ENTITY CLEAN_RESOURCES "<walltime>00:45:00</walltime><memory>500M</memory>">
<!ENTITY LIGHTNING_RESOURCES "<walltime>00:05:00</walltime><memory>4G</memory>">
<!ENTITY CONVENTIONAL_RESOURCES "<walltime>00:05:00</walltime><memory>2G</memory>">
<!ENTITY RADAR_RESOURCES "<walltime>00:10:00</walltime>">
<!ENTITY SATELLITE_RESOURCES "<walltime>00:05:00</walltime><memory>10G</memory>">
<!ENTITY GSI_HYB_RESOURCES "<walltime>00:40:00</walltime>">
<!ENTITY DIAG_STATS_RESOURCES "<walltime>00:05:00</walltime><memory>600M</memory>">
<!ENTITY POST_RESOURCES "<walltime>00:45:00</walltime>">
<!ENTITY NCL_RESOURCES "<walltime>00:55:00</walltime>">
<!ENTITY NCL_SKEWT_RESOURCES "<walltime>00:25:00</walltime><memory>9G</memory>">
<!ENTITY NCL_HTXS_RESOURCES "<walltime>00:25:00</walltime><memory>9G</memory>">
<!ENTITY UPDATE_VARS_RESOURCES "<walltime>00:08:00</walltime>">
<!ENTITY PYTHON_MAPS_RESOURCES "<walltime>02:35:00</walltime>">
<!ENTITY PYTHON_SKEWT_RESOURCES "<walltime>02:35:00</walltime>">

<!-- End gsi_hyb by 3 hr -->
<!-- End all post-processing by 6 hrs -->

<!ENTITY START_TIME_RADAR "00:10:00">
<!ENTITY START_TIME_CONVENTIONAL "00:38:00">
<!ENTITY START_TIME_NASACLOUD   "00:50:00">
<!ENTITY START_TIME_GSI "01:40:00">
<!ENTITY DEADLINE_DA "03:00:00">
<!ENTITY DEADLINE_UV "03:00:00">
<!ENTITY DEADLINE_PP "06:00:00">
<!ENTITY DEADLINE_PYTHON "06:00:00">

<!ENTITY WALL_LIMIT_DA '<deadline><cyclestr offset="&DEADLINE_DA;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_PP '<deadline><cyclestr offset="&DEADLINE_PP;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_UV '<deadline><cyclestr offset="&DEADLINE_UV;">@Y@m@d@H@M</cyclestr></deadline>'>
<!ENTITY WALL_LIMIT_PYTHON '<deadline><cyclestr offset="&DEADLINE_PYTHON;">@Y@m@d@H@M</cyclestr></deadline>'>

<!ENTITY RESERVATION '<native>--mail-type=NONE</native><queue>&QUEUE;</queue><account>&ACCOUNT;</account><partition>&PARTITION;</partition>'>
<!ENTITY RESERVATION_PRE '<native>--mail-type=NONE </native><queue>&QUEUE;</queue><account>&ACCOUNT;</account><partition>&PARTITION;</partition>'>
<!ENTITY RESERVATION_DA '<native>--mail-type=NONE </native><queue>&QUEUE;</queue><account>&ACCOUNT_DA;</account><partition>&PARTITION_DA;</partition>'>
<!ENTITY RESERVATION_POST '<native>--mail-type=NONE </native><queue>&QUEUE;</queue><account>&ACCOUNT;</account><partition>&PARTITION;</partition>'>
<!ENTITY RESERVATION_SMARTINIT '<native>--mail-type=NONE</native><queue>&QUEUE;</queue><account>&ACCOUNT;</account><partition>&PARTITION;</partition>'>
<!ENTITY RESERVATION_PYTHON '<native>--mail-type=NONE --exclusive</native><queue>&QUEUE;</queue><account>&ACCOUNT;</account><partition>&PARTITION_PYTHON;</partition>'>

<!ENTITY COMMONVARS
   '<envar><name>HOMErtma3d</name><value>&HOMEBASE_DIR;</value></envar>
    <envar><name>envir</name><value>&envir;</value></envar>
    <envar><name>SCHEDULER</name><value>&SCHEDULER;</value></envar>
    <envar><name>modulefile_jet</name><value>&MODULE_NCO;</value></envar>
    <envar><name>machine</name><value>&MACHINE;</value></envar>
    <envar><name>COMROOT</name><value>&DATABASE_DIR;</value></envar>
    <envar><name>jlogfile</name><value><cyclestr>&LOG_DIR;/@Y@m@d/jlogfile_@Y@m@d@H@M</cyclestr></value></envar>
    <envar><name>PDY</name><value><cyclestr>@Y@m@d</cyclestr></value></envar>
    <envar><name>cyc</name><value><cyclestr>@H</cyclestr></value></envar>
    <envar><name>subcyc</name><value><cyclestr>-1</cyclestr></value></envar>
    <envar><name>KEEPDATA</name><value>&KEEPDATA;</value></envar>
    <envar><name>DOMAIN</name><value>&DOMAIN;</value></envar>
'>

]>

<workflow realtime="T" scheduler="&SCHEDULER;" cyclethrottle="30" cyclelifespan="01:00:00:00">

  <log>
    <cyclestr>&LOG_DIR;/@Y@m@d/workflow_@Y@m@d@H@M.log</cyclestr>
  </log>

  <cycledef group="all">00  *    *  *  2020-2021 *</cycledef>
  <cycledef group="clean">00 *    *  *  2020-2021 *</cycledef>

  <task name="obsprep_lghtn" cycledefs="all" maxtries="3">

    &LIGHTNING_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION_PRE;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_OBSPREP_LGHTN</command>
    <cores>&LIGHTNING_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_obsprep_lghtn_@H@M</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/obsprep_lghtn_@Y@m@d@H@M.log</cyclestr></join>

    &COMMONVARS;
    <envar>
      <name>rundir_task</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>LIGHTNING_ROOT</name>
      <value>&LIGHTNING_DIR;</value>
    </envar>

      <dependency>
        <or>
          <datadep><cyclestr>&LIGHTNING_DIR;/vaisala/netcdf/@y@j@H@M0005r</cyclestr></datadep>
          <timedep><cyclestr offset="&START_TIME_RADAR;">@Y@m@d@H@M00</cyclestr></timedep>
        </or>
      </dependency>
  </task>

  <task name="obsprep_radar" cycledefs="all" maxtries="3">
    &RADAR_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION_POST;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_OBSPREP_RADAR</command>
    <cores>&RADAR_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_obsprep_radar_@H@M</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/obsprep_radar_@Y@m@d@H@M.log</cyclestr></join>

    &COMMONVARS;
    <envar>
      <name>rundir_task</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>COMINradar</name>
      <value>&RADAR_DIR;</value>
    </envar>

    <dependency>
      <or>
        <timedep><cyclestr offset="&START_TIME_RADAR;">@Y@m@d@H@M00</cyclestr></timedep>
        <rb><cyclestr offset="-0:01:00">!Dir.glob('&RADAR_DIR;/@Y@m@d-@H@M*.MRMS_MergedReflectivityQC_00.50_@Y@m@d-@H*.grib2').empty?</cyclestr></rb>
        <rb><cyclestr>!Dir.glob('&RADAR_DIR;/@Y@m@d-@H@M*.MRMS_MergedReflectivityQC_00.50_@Y@m@d-@H*.grib2').empty?</cyclestr></rb>
        <rb><cyclestr offset="0:01:00">!Dir.glob('&RADAR_DIR;/@Y@m@d-@H@M*.MRMS_MergedReflectivityQC_00.50_@Y@m@d-@H*.grib2').empty?</cyclestr></rb>
        <rb><cyclestr offset="0:02:00">!Dir.glob('&RADAR_DIR;/@Y@m@d-@H@M*.MRMS_MergedReflectivityQC_00.50_@Y@m@d-@H*.grib2').empty?</cyclestr></rb>
      </or>
    </dependency>
  </task>

  <task name="obsprep_cloud" cycledefs="all" maxtries="3">
    &SATELLITE_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION_PRE;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_OBSPREP_CLOUD</command>
    <cores>&SATELLITE_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_obsprep_cloud_@H@M</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/obsprep_cloud_@Y@m@d@H@M.log</cyclestr></join>

    &COMMONVARS;
    <envar>
      <name>rundir_task</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>NASALARC_DATA</name>
      <value>&LANGLEY_BUFR_DIR;</value>
    </envar>

    <dependency>
      <or>
        <datadep><cyclestr>&LANGLEY_BUFR_DIR;/@Y@m@d@H.rap.t@Hz.lgycld.tm00.bufr_d</cyclestr></datadep>
        <datadep><cyclestr>&LANGLEY_BUFR_DIR;/@Y@m@d@H.rap_e.t@Hz.lgycld.tm00.bufr_d</cyclestr></datadep>
        <timedep><cyclestr offset="&START_TIME_NASACLOUD;">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>
  </task>

  <task name="obsprep_basic" cycledefs="all" maxtries="3">

    &CONVENTIONAL_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION_PRE;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_OBSPREP_BASIC</command>
    <cores>&CONVENTIONAL_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_obsprep_basic_@H@M</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/obsprep_basic_@Y@m@d@H@M.log</cyclestr></join>

    &COMMONVARS;
    <envar>
      <name>rundir_task</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>PREPBUFR</name>
      <value>&PREPBUFR_DIR;</value>
    </envar>
    <envar>
      <name>RADVELLEV2_DIR</name>
      <value>&RADVELLEV2_DIR;</value>
    </envar>
    <envar>
      <name>SATWND_DIR</name>
      <value>&SATWND_DIR;</value>
    </envar>

    <dependency>
      <or>
        <and>
          <or>
            <datadep age="00:02:00"><cyclestr>&PREPBUFR_DIR;/@Y@m@d@H.rap.t@Hz.prepbufr.tm00</cyclestr></datadep>
            <datadep age="00:02:00"><cyclestr>&PREPBUFR_DIR;/@Y@m@d@H.rap_e.t@Hz.prepbufr.tm00</cyclestr></datadep>
          </or>
<!--for sub-hourly run
          <datadep age="00:02:00"><cyclestr>&PREPBUFR_DIR;/@Y@m@d@H@M.rtma_ru.t@H@Mz.prepbufr.tm00</cyclestr></datadep>
-->
        </and>
        <timedep><cyclestr offset="&START_TIME_CONVENTIONAL;">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>

  </task>

  <task name="gsianl" cycledefs="all" maxtries="3">

    &GSI_HYB_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION_DA;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_GSIANL</command>
    <nodes>&GSI_HYB_PROC;</nodes>
    <jobname><cyclestr>&JOBNAME_PRE;_gsianl_@H@M</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/gsianl_@Y@m@d@H@M.log</cyclestr></join>

    &COMMONVARS;
    <envar>
      <name>rundir_task</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/gsiprd</cyclestr></value>
    </envar>
    <envar>
      <name>AIRCRAFT_REJECT</name>
      <value>&AIRCRAFT_REJECT;</value>
    </envar>
    <envar>
      <name>SFCOBS_USELIST</name>
      <value>&SFCOBS_USELIST;</value>
    </envar>
    <envar>
      <name>HRRR_DIR</name>
      <value>&HRRRfcst_DIR;</value>
    </envar>
    <envar>
      <name>OBS_DIR</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/obsprd</cyclestr></value>
    </envar>
    <envar>
      <name>ENKF_FCST</name>
      <value>&ENKFFCST_DIR;</value>
    </envar>
    <envar>
      <name>COMINhrrrdas</name>
      <value>&HRRRDAS_DIR;</value>
    </envar>
    <envar>
      <name>HRRRDAS_SMALL</name>
      <value>1</value>
    </envar>
    <envar>
      <name>HRRRDAS_BEC</name>
      <value>0</value>
    </envar>
    <envar>
      <name>GSIANL_RES</name>
      <value>3km</value>
    </envar>
    <envar>
      <name>EnsWgt</name>
      <value>0.5</value>
    </envar>
    <envar><name>FG_FALLBACK</name><value>&FG_FALLBACK;</value></envar>

    <dependency>
      <and>
        <datadep age="00:06:00">&HRRRfcst_DIR;/<cyclestr offset="-1:00:00">@Y@m@d@H</cyclestr>/wrfprd/<cyclestr>wrfout_d01_@Y-@m-@d_@H_00_00</cyclestr></datadep>
        <or> 
          <and>
            <taskdep task="obsprep_radar"/>
            <taskdep task="obsprep_lghtn"/>
            <taskdep task="obsprep_basic"/>
            <taskdep task="obsprep_cloud"/>
            <!--to use HRRRDAS BEC, need to add other dependencies here  -->
          </and>
          <timedep><cyclestr offset="&START_TIME_GSI;">@Y@m@d@H@M00</cyclestr></timedep>
        </or>
      </and>
    </dependency>

  </task>

  <task name="diagstats" cycledefs="all" maxtries="3">

    &DIAG_STATS_RESOURCES;
    &WALL_LIMIT_DA;
    &RESERVATION;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_DIAGSTATS</command>
    <cores>&DIAG_STATS_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_diag_stats_@H@M</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/diag_stats_@Y@m@d@H@M.log</cyclestr></join>

    &COMMONVARS;
    <envar>
      <name>rundir_task</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/diagprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSIRUN_DIR</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/gsiprd</cyclestr></value>
    </envar>
    <envar>
      <name>GSIRUN_CORES</name>
      <value>&GSIRUN_CORES;</value>
    </envar>

    <dependency>
      <taskdep task="gsianl"/>
    </dependency>

  </task>

  <task name="updatevars" cycledefs="all" maxtries="3">

    &UPDATE_VARS_RESOURCES;
    &WALL_LIMIT_UV;
    &RESERVATION_DA;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_UPDATEVARS</command>
    <cores>&WRF_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_updatevars_@H@M</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/updatevars_@Y@m@d@H@M.log</cyclestr></join>

    &COMMONVARS;
    <envar>
      <name>rundir_task</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/wrfprd</cyclestr></value>
    </envar>
    <envar>
      <name>FCST_LENGTH</name>
      <value>&FCST_LENGTH;</value>
    </envar>
    <envar>
      <name>GSIRUN_DIR</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/gsiprd</cyclestr></value>
    </envar>

    <dependency>
        <taskdep task="gsianl"/>
    </dependency>

  </task>

  <task name="post" cycledefs="all" maxtries="3">

    &POST_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION_POST;

    <command>&JJOB_DIR;/launch.ksh &JJOB_DIR;/JRTMA3D_POST</command>
    <cores>&POST_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_post_@H@M</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/post_@Y@m@d@H@M.log</cyclestr></join>

    &COMMONVARS;
    <envar>
      <name>rundir_task</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/postprd</cyclestr></value>
    </envar>
    <envar>
      <name>FIXcrtm</name>
      <value>/home/rtrr/FIX_EXEC_MODULE/crtm/CRTM_v2.2.6</value>
    </envar>
    <envar>
      <name>FCST_TIME</name>
      <value>00</value>
    </envar>
    <envar>
      <name>WRFOUT_DIR</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/gsiprd</cyclestr></value>
    </envar>
    <envar>
      <name>POST_NAME</name>
      <value>&POST_NAME;</value>
    </envar>

    <dependency>
      <taskdep task="updatevars"/>
    </dependency>

  </task>

  <task name="smartinit_bl" cycledefs="all" maxtries="3">

    &SMARTINIT_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION_SMARTINIT;

    <command>&JJOB_DIR;/launch.ksh &SCRIPT_DIR;/exrtma3d_smartinit_bl.ksh</command>
    <cores>&SMARTINIT_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_smartinit_@H@M_bl</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/smartinit_@Y@m@d@H@M_bl.log</cyclestr></join>

    &COMMONVARS;
    <envar>
      <name>rundir_task</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/smtiprd</cyclestr></value>
    </envar>
    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>FCST_TIME</name>
      <value>00</value>
    </envar>
    <envar>
      <name>EXE_ROOT</name>
      <value>&SMARTINIT_EXEC;</value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/smtiprd</cyclestr></value>
    </envar>
    <envar>
      <name>DATAPOSTHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/postprd</cyclestr></value>
    </envar>
    <envar>
      <name>MODEL</name>
      <value>HRRR</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/smartinit</value>
    </envar>

    <dependency>
      <datadep age="00:02:00">&DATAROOT;/<cyclestr>@Y@m@d@H</cyclestr>/postprd<cyclestr>/wrfnat_hrconus_00.grib2</cyclestr></datadep>
    </dependency>

  </task>

  <task name="smartinit_nb" cycledefs="all" maxtries="3">

    &SMARTINIT_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION_SMARTINIT;

    <command>&JJOB_DIR;/launch.ksh &SCRIPT_DIR;/exrtma3d_smartinit_nb.ksh</command>
    <cores>&SMARTINIT_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_smartinit_@H@M_nb</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/smartinit_@Y@m@d@H@M_nb.log</cyclestr></join>

    &COMMONVARS;
    <envar>
      <name>rundir_task</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/smtiprd</cyclestr></value>
    </envar>
    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>FCST_TIME</name>
      <value>00</value>
    </envar>
    <envar>
      <name>EXE_ROOT</name>
      <value>&SMARTINIT_EXEC;</value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/smtiprd</cyclestr></value>
    </envar>
    <envar>
      <name>DATAPOSTHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H/postprd</cyclestr></value>
    </envar>
    <envar>
      <name>MODEL</name>
      <value>HRRR</value>
    </envar>
    <envar>
      <name>STATIC_DIR</name>
      <value>&STATIC_DIR;/smartinit</value>
    </envar>

    <dependency>
      <datadep age="00:02:00">&DATAROOT;/<cyclestr>@Y@m@d@H</cyclestr>/postprd<cyclestr>/wrfnat_hrconus_00.grib2</cyclestr></datadep>
    </dependency>

  </task>

  <!--
  <task name="ncl_00" cycledefs="all" maxtries="3">

    &NCL_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION;

    <command>&SCRIPTS;/NCL/ncl_hrrr.ksh</command>
    <cores>&NCL_MAIN_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_ncl_@H_@M</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/ncl_@Y@m@d@H@M_00.log</cyclestr></join>

    <envar>
      <name>MODULE_FILE</name>
      <value>&MODULE_FILE;</value>
    </envar>
    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>FCST_TIME</name>
      <value>00</value>
    </envar>
    <envar>
      <name>NCL_VER</name>
      <value>&NCL_VER;</value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>MODEL</name>
      <value>&SYSTEM_ID;</value>
    </envar>

    <dependency>
      <taskdep task="post"/>
    </dependency>

  </task>
  -->

  <task name="python_maps" cycledefs="all" maxtries="1">

    &PYTHON_MAPS_RESOURCES;
    &WALL_LIMIT_PYTHON;
    &RESERVATION_PYTHON;

    <nodes>&PYTHON_MAPS_NODES;</nodes>
    <jobname><cyclestr>&JOBNAME_PRE;_python_@H_@M_map</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/python_@Y@m@d@H@M_map.log</cyclestr></join>

    <command>
      <cyclestr>
        source &PYTHON_SCRIPTS;/pre.sh;
        cd &PYTHON_SCRIPTS; ;
        python &PYTHON_SCRIPTS;/create_graphics.py \
          maps \
          -d &DATAROOT;/@Y@m@d@H/postprd \
          -f 0 \
          --file_tmpl wrfprs_hrconus_{FCST_TIME:02d}.grib2 \
          --file_type prs \
          --images &PYTHON_SCRIPTS;/image_lists/rtma.yml hourly\
          -n ${SLURM_CPUS_ON_NODE:-12} \
          -o &DATAROOT;/@Y@m@d@H/pyprd/maps \
          -s @Y@m@d@H \
          --tiles all \
          -z &DATAROOT;/@Y@m@d@H/nclprd
      </cyclestr>
    </command>

    <dependency>
      <taskdep task="post"/>
    </dependency>
  </task>

  <task name="python_skewt" cycledefs="all" maxtries="1">

    &PYTHON_SKEWT_RESOURCES;
    &WALL_LIMIT_PYTHON;
    &RESERVATION_PYTHON;

    <nodes>&PYTHON_SKEWT_NODES;</nodes>
    <jobname><cyclestr>&JOBNAME_PRE;_python_@H_@M_skewt</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/python_@Y@m@d@H@M_skewt.log</cyclestr></join>

    <command>
      <cyclestr>
        source &PYTHON_SCRIPTS;/pre.sh;
        cd &PYTHON_SCRIPTS; ;
        python &PYTHON_SCRIPTS;/create_graphics.py \
          skewts \
          -d &DATAROOT;/@Y@m@d@H/postprd \
          -f 0 \
          --file_tmpl wrfnat_hrconus_00.grib2 \
          --file_type nat \
          --max_plev 100 \
          -n ${SLURM_CPUS_ON_NODE:-12} \
          -o &DATAROOT;/@Y@m@d@H/pyprd/skewt \
          -s @Y@m@d@H \
          -z &DATAROOT;/@Y@m@d@H/nclprd/skewt \
          --sites &PYTHON_SCRIPTS;/static/conus_raobs.txt
      </cyclestr>
    </command>

    <dependency>
      <taskdep task="post"/>
    </dependency>

  </task>

  <!--
  <metatask>
    <var name="skewt">skewt1 skewt2 skewt5</var>

    <task name="ncl_00_#skewt#" cycledefs="all" maxtries="3">

      &NCL_SKEWT_RESOURCES;
      &WALL_LIMIT_PP;
      &RESERVATION;

      <command>&SCRIPTS;/NCL/ncl_hrrr_#skewt#.ksh</command>
      <cores>&NCL_PROC;</cores>
      <jobname><cyclestr>&JOBNAME_PRE;_ncl_@H_@M_#skewt#</cyclestr></jobname>
      <join><cyclestr>&LOG_DIR;/@Y@m@d/ncl_@Y@m@d@H@M_00_#skewt#.log</cyclestr></join>

      <envar>
        <name>MODULE_FILE</name>
        <value>&MODULE_FILE;</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>FCST_TIME</name>
        <value>00</value>
      </envar>
      <envar>
        <name>NCL_VER</name>
        <value>&NCL_VER;</value>
      </envar>
      <envar>
        <name>DATAROOT</name>
        <value>&DATAROOT;</value>
      </envar>
      <envar>
        <name>DATAHOME</name>
        <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MODEL</name>
        <value>&SYSTEM_ID;</value>
      </envar>

      <dependency>
        <taskdep task="post"/>
      </dependency>

    </task>

  </metatask>
  -->

  <metatask>
    <var name="htxs">htxs1</var>

    <task name="ncl_00_#htxs#" cycledefs="all" maxtries="3">

      &NCL_HTXS_RESOURCES;
      &WALL_LIMIT_PP;
      &RESERVATION;

      <command>&SCRIPTS;/NCL/ncl_hrrr_#htxs#.ksh</command>
      <cores>&NCL_PROC;</cores>
      <jobname><cyclestr>&JOBNAME_PRE;_ncl_@H_@M_#htxs#</cyclestr></jobname>
      <join><cyclestr>&LOG_DIR;/@Y@m@d/ncl_@Y@m@d@H@M_00_#htxs#.log</cyclestr></join>

      <envar>
        <name>MODULE_FILE</name>
        <value>&MODULE_FILE;</value>
      </envar>
      <envar>
        <name>START_TIME</name>
        <value><cyclestr>@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>FCST_TIME</name>
        <value>00</value>
      </envar>
      <envar>
        <name>NCL_VER</name>
        <value>&NCL_VER;</value>
      </envar>
      <envar>
        <name>DATAROOT</name>
        <value>&DATAROOT;</value>
      </envar>
      <envar>
        <name>DATAHOME</name>
        <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
      </envar>
      <envar>
        <name>MODEL</name>
        <value>&SYSTEM_ID;</value>
      </envar>

      <dependency>
        <taskdep task="post"/>
      </dependency>

    </task>

  </metatask>

  <!--
  <task name="ncl_zip" cycledefs="all" maxtries="3">

    &NCL_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION;

    <command>&SCRIPTS;/NCL/ncl_hrrr_zip.ksh</command>
    <cores>&NCL_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_ncl_@H_zip</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/ncl_@Y@m@d@H@M_zip.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>

    <dependency>
      <or>
        <taskdep task="ncl_00"/>
        <timedep><cyclestr offset="03:00:00">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>
    
  </task>

  <task name="ncl_skewt_zip" cycledefs="all" maxtries="3">

    &NCL_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION;

    <command>&SCRIPTS;/NCL/ncl_hrrr_skewt_zip.ksh</command>
    <cores>&NCL_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_ncl_@H_skewt_zip</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/ncl_@Y@m@d@H@M_skewt_zip.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>

    <dependency>
      <or>
        <and>
          <taskdep task="ncl_00_skewt1"/>
          <taskdep task="ncl_00_skewt2"/>
          <taskdep task="ncl_00_skewt5"/>
        </and>
        <timedep><cyclestr offset="03:00:00">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>
    
  </task>
  -->

  <task name="ncl_htxs_zip" cycledefs="all" maxtries="3">

    &NCL_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION;

    <command>&SCRIPTS;/NCL/ncl_hrrr_htxs_zip.ksh</command>
    <cores>&NCL_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_ncl_@H_htxs_zip</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/ncl_@Y@m@d@H@M_htxs_zip.log</cyclestr></join>

    <envar>
      <name>START_TIME</name>
      <value><cyclestr>@Y@m@d@H</cyclestr></value>
    </envar>
    <envar>
      <name>DATAROOT</name>
      <value>&DATAROOT;</value>
    </envar>
    <envar>
      <name>DATAHOME</name>
      <value><cyclestr>&DATAROOT;/@Y@m@d@H</cyclestr></value>
    </envar>

    <dependency>
      <or>
        <and>
          <taskdep task="ncl_00_htxs1"/>
        </and>
        <timedep><cyclestr offset="02:55:00">@Y@m@d@H@M00</cyclestr></timedep>
      </or>
    </dependency>
    
  </task>

  <task name="clean" cycledefs="clean" maxtries="3">

    &CLEAN_RESOURCES;
    &WALL_LIMIT_PP;
    &RESERVATION_POST;

    <command>&JJOB_DIR;/launch.ksh &SCRIPTS;/clean.ksh</command>
    <cores>&CLEAN_PROC;</cores>
    <jobname><cyclestr>&JOBNAME_PRE;_clean_@H@M</cyclestr></jobname>
    <join><cyclestr>&LOG_DIR;/@Y@m@d/clean_@Y@m@d@H@M.log</cyclestr></join>

    &COMMONVARS;
    <envar>
      <name>WORK_ROOT</name>
      <value>&DATABASE_DIR;</value>
    </envar>
    <envar>
      <name>CYCLE_HOUR</name>
      <value><cyclestr>@H</cyclestr></value>
    </envar>
    <envar>
      <name>rundir_task</name>
      <value>none</value>
    </envar>

  </task>

</workflow>
